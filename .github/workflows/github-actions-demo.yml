name: GitHub Actions Demo

on:
  push:
    branches:
      - master

jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Check out repository code
        uses: actions/checkout@v4

      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.23'  # Specify the version of Go you want to use

      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."

      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}

      - name: Run Go application
        run: go run .

      - name: Get latest version tag
        id: get_tag
        run: |
          latest_tag=$(git describe --tags $(git rev-list --tags --max-count=1))
          echo "Latest tag: $latest_tag"
          if [ -z "$latest_tag" ]; then
            latest_tag="v0.0.0"
          fi
          echo "Latest version is $latest_tag"
          echo "LATEST_TAG=$latest_tag" >> $GITHUB_ENV

      - name: Increment version
        run: |
          IFS='.' read -r major minor patch <<< "${{ env.LATEST_TAG#v }}"
          patch=$((patch + 1)) # Increment patch version
          NEW_VERSION="$major.$minor.$patch"
          echo "New Version: $NEW_VERSION"
          # Update version.go with the new version
          sed -i "s/^var Version = \".*\"/var Version = \"$NEW_VERSION\"/" version.go
          echo "Updated version.go with version $NEW_VERSION"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Commit version bump
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add version.go
          git commit -m "Bump version to ${{ env.NEW_VERSION }}"

      - name: Push changes
        run: |
          git push origin master

      - name: Tag the repository
        if: success()  # Only run this step if the previous steps were successful
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Use the GitHub token provided by GitHub Actions
        run: |
          git tag "v${{ env.NEW_VERSION }}"
          git push origin "v${{ env.NEW_VERSION }}"

      - run: echo "üçè This job's status is ${{ job.status }}."
